
# **TP Sécurité – Détection d’un service malveillant avec systemd et outils de diagnostic Linux**

## Objectifs pédagogiques

* Comprendre les principes de base de la sécurité système sous Linux.
* Apprendre à identifier un comportement anormal via les processus, services et journaux.
* Savoir diagnostiquer un service systemd malveillant ou non autorisé.
* Appliquer des commandes d’audit et d’analyse de l’activité système.

> **Attention :** Ce TP est réalisé **dans un environnement de test contrôlé**. Il est strictement interdit de reproduire ces pratiques sur un système en production ou dans un réseau partagé.

---

## Environnement requis

* Une machine virtuelle Linux (Ubuntu Server ou Desktop).
* Accès root ou `sudo`.
* Aucun antivirus ni politique de sécurité bloquante locale.

---

## Partie 1 – Simulation d’un comportement malveillant

### Étape 1 – Création d’un processus caché

```bash
ln -s /bin/bash /tmp/.sshd_hidden
/tmp/.sshd_hidden -c 'while true; do sleep 60; done' &
```

Cela crée un shell nommé de façon suspecte (simulant une porte dérobée) qui tourne en arrière-plan.

### Étape 2 – Vérification avec `ps` et `top`

```bash
ps aux | grep sshd
```

ou :

```bash
top
```

Note : ce processus ne sera pas rattaché à un service systemd.

---

## Partie 2 – Création d’un faux service systemd

### Étape 1 – Créer un service caché

Créer un fichier dans `/etc/systemd/system/fakebackdoor.service` :

```ini
[Unit]
Description=Fake Backdoor Demo

[Service]
ExecStart=/bin/bash -c 'while true; do echo "active" >> /tmp/spy.log; sleep 30; done'

[Install]
WantedBy=multi-user.target
```

### Étape 2 – Activer et démarrer le service

```bash
sudo systemctl daemon-reexec
sudo systemctl enable --now fakebackdoor.service
```

---

## Partie 3 – Détection du comportement anormal

### Étape 1 – Recherche des services suspects

```bash
systemctl list-units --type=service | grep backdoor
```

ou :

```bash
systemctl list-units --type=service | grep -i tmp
```

### Étape 2 – Utiliser systemd-cgls

```bash
systemd-cgls | grep fakebackdoor
```

Permet de visualiser les processus et leur hiérarchie.

### Étape 3 – Inspecter les processus avec `pstree`

```bash
pstree -ap | grep bash
```

Permet de détecter les shells en arrière-plan.

### Étape 4 – Vérification des fichiers suspects

```bash
find /tmp -type f -name '*sshd*'
ls -la /tmp
```

### Étape 5 – Analyse des fichiers journaux

```bash
journalctl -u fakebackdoor.service
```

ou :

```bash
journalctl -p 3 --since "10 minutes ago"
```

---

## Partie 4 – Surveillance du comportement du système

### Étape 1 – Rechercher les fichiers récemment modifiés

```bash
find /etc -type f -mtime -1
find /var/tmp -type f -mmin -30
```

### Étape 2 – Vérifier les connexions et ports ouverts

```bash
sudo lsof -i
sudo netstat -tulnp
```

---

## Partie 5 – Nettoyage du système

### Étape 1 – Supprimer le service systemd

```bash
sudo systemctl stop fakebackdoor.service
sudo systemctl disable fakebackdoor.service
sudo rm /etc/systemd/system/fakebackdoor.service
sudo systemctl daemon-reload
```

### Étape 2 – Supprimer le processus caché

```bash
pkill -f .sshd_hidden
rm /tmp/.sshd_hidden
```

### Étape 3 – Supprimer les journaux générés

```bash
rm /tmp/spy.log
```

---

## Évaluation possible

Proposez aux étudiants une situation où **plusieurs services et processus sont présents**, et demandez-leur :

* Quels sont les services suspects ?
* Quels ports sont utilisés ?
* Quels journaux montrent une anomalie ?
* Quelles commandes permettent de confirmer l’activité ?
* Quelles actions de mitigation ou de suppression sont nécessaires ?


