
# **TP SÃ©curitÃ© â€“ DÃ©tection dâ€™un service malveillant avec systemd et outils de diagnostic Linux**

## Objectifs pÃ©dagogiques

* Comprendre les principes de base de la sÃ©curitÃ© systÃ¨me sous Linux.
* Apprendre Ã  identifier un comportement anormal via les processus, services et journaux.
* Savoir diagnostiquer un service systemd malveillant ou non autorisÃ©.
* Appliquer des commandes dâ€™audit et dâ€™analyse de lâ€™activitÃ© systÃ¨me.

> **Attention :** Ce TP est rÃ©alisÃ© **dans un environnement de test contrÃ´lÃ©**. Il est strictement interdit de reproduire ces pratiques sur un systÃ¨me en production ou dans un rÃ©seau partagÃ©.

---

## Environnement requis

* Une machine virtuelle Linux (Ubuntu Server ou Desktop).
* AccÃ¨s root ou `sudo`.
* Aucun antivirus ni politique de sÃ©curitÃ© bloquante locale.

---

## Partie 1 â€“ Simulation dâ€™un comportement malveillant

### Ã‰tape 1 â€“ CrÃ©ation dâ€™un processus cachÃ©

```bash
ln -s /bin/bash /tmp/.sshd_hidden
/tmp/.sshd_hidden -c 'while true; do sleep 60; done' &
```

Cela crÃ©e un shell nommÃ© de faÃ§on suspecte (simulant une porte dÃ©robÃ©e) qui tourne en arriÃ¨re-plan.

### Ã‰tape 2 â€“ VÃ©rification avec `ps` et `top`

```bash
ps aux | grep sshd
```

ou :

```bash
top
```

Note : ce processus ne sera pas rattachÃ© Ã  un service systemd.

---

## Partie 2 â€“ CrÃ©ation dâ€™un faux service systemd

### Ã‰tape 1 â€“ CrÃ©er un service cachÃ©

CrÃ©er un fichier dans `/etc/systemd/system/fakebackdoor.service` :

```ini
[Unit]
Description=Fake Backdoor Demo

[Service]
ExecStart=/bin/bash -c 'while true; do echo "active" >> /tmp/spy.log; sleep 30; done'

[Install]
WantedBy=multi-user.target
```

### Ã‰tape 2 â€“ Activer et dÃ©marrer le service

```bash
sudo systemctl daemon-reexec
sudo systemctl enable --now fakebackdoor.service
```

---

## Partie 3 â€“ DÃ©tection du comportement anormal

### Ã‰tape 1 â€“ Recherche des services suspects

```bash
systemctl list-units --type=service | grep backdoor
```

ou :

```bash
systemctl list-units --type=service | grep -i tmp
```

### Ã‰tape 2 â€“ Utiliser systemd-cgls

```bash
systemd-cgls | grep fakebackdoor
```

Permet de visualiser les processus et leur hiÃ©rarchie.

### Ã‰tape 3 â€“ Inspecter les processus avec `pstree`

```bash
pstree -ap | grep bash
```

Permet de dÃ©tecter les shells en arriÃ¨re-plan.

### Ã‰tape 4 â€“ VÃ©rification des fichiers suspects

```bash
find /tmp -type f -name '*sshd*'
ls -la /tmp
```

### Ã‰tape 5 â€“ Analyse des fichiers journaux

```bash
journalctl -u fakebackdoor.service
```

ou :

```bash
journalctl -p 3 --since "10 minutes ago"
```

---

## Partie 4 â€“ Surveillance du comportement du systÃ¨me

### Ã‰tape 1 â€“ Rechercher les fichiers rÃ©cemment modifiÃ©s

```bash
find /etc -type f -mtime -1
find /var/tmp -type f -mmin -30
```

### Ã‰tape 2 â€“ VÃ©rifier les connexions et ports ouverts

```bash
sudo lsof -i
sudo netstat -tulnp
```

---

## Partie 5 â€“ Nettoyage du systÃ¨me

### Ã‰tape 1 â€“ Supprimer le service systemd

```bash
sudo systemctl stop fakebackdoor.service
sudo systemctl disable fakebackdoor.service
sudo rm /etc/systemd/system/fakebackdoor.service
sudo systemctl daemon-reload
```

### Ã‰tape 2 â€“ Supprimer le processus cachÃ©

```bash
pkill -f .sshd_hidden
rm /tmp/.sshd_hidden
```

### Ã‰tape 3 â€“ Supprimer les journaux gÃ©nÃ©rÃ©s

```bash
rm /tmp/spy.log
```

---

## Ã‰valuation possible

Proposez aux Ã©tudiants une situation oÃ¹ **plusieurs services et processus sont prÃ©sents**, et demandez-leur :

* Quels sont les services suspects ?
* Quels ports sont utilisÃ©s ?
* Quels journaux montrent une anomalie ?
* Quelles commandes permettent de confirmer lâ€™activitÃ© ?
* Quelles actions de mitigation ou de suppression sont nÃ©cessaires ?


















## ğŸ“„ `audit_persistence.sh` â€” Script dâ€™audit dâ€™un processus malveillant rÃ©current

```bash
#!/bin/bash

echo "=== [ Audit de persistance â€“ Processus relanÃ§ant spy.log ] ==="

echo -e "\n[1] Recherche de processus actifs liÃ©s Ã  'spy.log' ou bash en boucle :"
ps -ef | grep -E "spy\.log|sshd_hidden|while true" | grep -v grep

echo -e "\n[2] Recherche des parents (PPID) :"
for pid in $(pgrep -f spy.log); do
    echo "PID : $pid"
    pstree -ps "$pid"
done

echo -e "\n[3] Recherche dans les services systemd :"
grep -r "spy.log" /etc/systemd/system/ 2>/dev/null

echo -e "\n[4] Analyse de tous les services systemd en mÃ©moire :"
systemctl list-units --type=service | xargs -n1 -I{} bash -c 'systemctl cat {} 2>/dev/null | grep -q "spy.log" && echo {}'

echo -e "\n[5] Recherche dans les fichiers cron (root et utilisateur) :"
echo "Crontab root :"
sudo crontab -l 2>/dev/null | grep spy.log
echo "Crontab utilisateur courant :"
crontab -l 2>/dev/null | grep spy.log
echo "Autres fichiers cron :"
grep -r spy.log /etc/cron.* 2>/dev/null

echo -e "\n[6] Fichiers de dÃ©marrage automatique (/etc/rc.local, .bashrc, etc.) :"
grep -r spy.log /etc/rc.local /etc/profile /etc/bash.bashrc /home/*/.bashrc 2>/dev/null

echo -e "\n[7] Recherche dans les timers systemd :"
systemctl list-timers --all | awk '{print $1}' | grep -v "^NEXT" | while read timer; do
    systemctl cat "$timer" 2>/dev/null | grep -q spy.log && echo "$timer"
done

echo -e "\n[8] Recherche gÃ©nÃ©rale dans tout le systÃ¨me (attention : lent) :"
grep -r spy.log /etc /opt /var /home 2>/dev/null | grep -v "Permission denied"

echo -e "\n=== Fin de l'audit ==="
```

---

## ğŸ“Œ Instructions d'utilisation

1. **CrÃ©er le fichier** :

```bash
nano audit_persistence.sh
```

2. **Coller le code ci-dessus**, enregistrer, puis rendre exÃ©cutable :

```bash
chmod +x audit_persistence.sh
```

3. **Lancer le script** :

```bash
sudo ./audit_persistence.sh
```

---

## ğŸ“¦ Ce que ce script permet dâ€™identifier

* Tout processus en cours qui Ã©crit dans `/tmp/spy.log`
* Les parents Ã©ventuels (`pstree`)
* Les services `systemd` qui pourraient contenir `spy.log`
* Les entrÃ©es `cron` ou dÃ©marrage automatique
* Les timers `systemd`
* Les relances dissimulÃ©es via `.bashrc`, `rc.local`, etc.



